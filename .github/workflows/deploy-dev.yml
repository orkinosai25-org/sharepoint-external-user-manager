name: Deploy to Dev Environment

on:
  push:
    branches: [ develop ]
    paths:
      - 'src/**'
      - 'infra/bicep/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: 'Deploy infrastructure (Bicep templates)'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.19.0'
  AZURE_RESOURCE_GROUP: 'spexternal-dev-rg'
  ENVIRONMENT: 'dev'

jobs:
  # Job 1: Build all components
  build:
    name: Build All Components
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Build API
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Build API
      run: |
        cd src/api-dotnet/WebApi/SharePointExternalUserManager.Api
        dotnet restore
        dotnet build --configuration Release --no-restore
        dotnet publish --configuration Release --output ../../../../api-publish --no-build
        
    - name: Build Blazor Portal
      run: |
        cd src/portal-blazor/SharePointExternalUserManager.Portal
        dotnet restore
        dotnet build --configuration Release --no-restore
        dotnet publish --configuration Release --output ../../../../portal-publish --no-build
        
    # Build SPFx
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/client-spfx/package-lock.json'
        
    - name: Build SPFx Client
      run: |
        cd src/client-spfx
        npm ci --no-optional --legacy-peer-deps
        npm run build
        npm run package-solution
        
    # Upload artifacts
    - name: Upload API artifact
      uses: actions/upload-artifact@v4
      with:
        name: api-package
        path: api-publish
        retention-days: 1
        
    - name: Upload Portal artifact
      uses: actions/upload-artifact@v4
      with:
        name: portal-package
        path: portal-publish
        retention-days: 1
        
    - name: Upload SPFx artifact
      uses: actions/upload-artifact@v4
      with:
        name: spfx-package
        path: src/client-spfx/sharepoint/solution/*.sppkg
        retention-days: 1
        
  # Job 2: Deploy Infrastructure (optional, manual trigger only)
  deploy-infrastructure:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    # Only run if workflow was manually triggered with deploy_infrastructure=true AND Azure credentials are configured
    if: github.event.inputs.deploy_infrastructure == 'true' && secrets.AZURE_CREDENTIALS
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy Bicep template
      run: |
        az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infra/bicep/main.bicep \
          --parameters environment=${{ env.ENVIRONMENT }} \
          --parameters sqlAdminUsername=${{ secrets.SQL_ADMIN_USERNAME }} \
          --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
          
    - name: Get deployment outputs
      id: deployment
      run: |
        outputs=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name main \
          --query properties.outputs)
        echo "Deployment outputs:"
        echo "$outputs"
        
    - name: Logout from Azure
      run: az logout
      
  # Job 3: Deploy API
  deploy-api:
    name: Deploy API to Azure
    runs-on: ubuntu-latest
    needs: build
    # Only run if Azure credentials and API app name are configured
    if: secrets.AZURE_CREDENTIALS && secrets.API_APP_NAME
    environment: development
    
    steps:
    - name: Download API artifact
      uses: actions/download-artifact@v4
      with:
        name: api-package
        path: ./api-package
        
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.API_APP_NAME }}
        package: ./api-package
        
    - name: Logout from Azure
      run: az logout
      
  # Job 4: Deploy Blazor Portal
  deploy-portal:
    name: Deploy Blazor Portal to Azure
    runs-on: ubuntu-latest
    needs: build
    # Only run if Azure credentials and Portal app name are configured
    if: secrets.AZURE_CREDENTIALS && secrets.PORTAL_APP_NAME
    environment: development
    
    steps:
    - name: Download Portal artifact
      uses: actions/download-artifact@v4
      with:
        name: portal-package
        path: ./portal-package
        
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.PORTAL_APP_NAME }}
        package: ./portal-package
        
    - name: Logout from Azure
      run: az logout
      
  # Job 5: Health Check
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-portal]
    # Only run if deploy jobs ran (which means secrets are configured)
    if: always() && secrets.AZURE_CREDENTIALS && secrets.API_APP_NAME && secrets.PORTAL_APP_NAME
    
    steps:
    - name: Check API Health
      run: |
        echo "Waiting 30 seconds for services to start..."
        sleep 30
        
        api_url="${{ secrets.API_APP_URL }}/health"
        echo "Checking API health at: $api_url"
        
        response=$(curl -s -o /dev/null -w "%{http_code}" $api_url || echo "000")
        
        if [ "$response" -eq 200 ]; then
          echo "âœ… API health check passed"
        else
          echo "âš ï¸ API health check returned: $response"
          echo "Note: This may be expected if /health endpoint is not yet implemented"
        fi
        
    - name: Check Portal Health
      run: |
        portal_url="${{ secrets.PORTAL_APP_URL }}"
        echo "Checking Portal health at: $portal_url"
        
        response=$(curl -s -o /dev/null -w "%{http_code}" $portal_url || echo "000")
        
        if [ "$response" -eq 200 ] || [ "$response" -eq 302 ]; then
          echo "âœ… Portal health check passed"
        else
          echo "âš ï¸ Portal health check returned: $response"
        fi
        
    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Dev Environment Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: Development" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployed Components" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… API App Service" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Blazor Portal" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SPFx Package Built" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Verify API at: ${{ secrets.API_APP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify Portal at: ${{ secrets.PORTAL_APP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "3. Deploy SPFx package to SharePoint App Catalog" >> $GITHUB_STEP_SUMMARY
