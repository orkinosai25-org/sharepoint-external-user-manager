name: Deploy to Production Environment

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'infra/bicep/**'
      - '.github/workflows/deploy-prod.yml'
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: 'Deploy infrastructure (Bicep templates)'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.19.0'
  AZURE_RESOURCE_GROUP: 'spexternal-prod-rg'
  ENVIRONMENT: 'prod'

permissions:
  contents: read

jobs:
  # Job 1: Build all components
  build:
    name: Build All Components
    runs-on: ubuntu-latest
    outputs:
      portal-built: ${{ steps.validate-secrets.outputs.has-secrets }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Build API
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Build API
      run: |
        cd src/api-dotnet/WebApi/SharePointExternalUserManager.Api
        dotnet restore
        dotnet build --configuration Release --no-restore
        dotnet publish --configuration Release --output ../../../../api-publish --no-build
        
    - name: Validate Azure AD Secrets
      id: validate-secrets
      env:
        AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
        AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
        AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}
      run: |
        errors=""
        
        if [ -z "$AZURE_AD_CLIENT_ID" ]; then
          errors="$errors AZURE_AD_CLIENT_ID"
        fi
        if [ -z "$AZURE_AD_CLIENT_SECRET" ]; then
          errors="$errors AZURE_AD_CLIENT_SECRET"
        fi
        if [ -z "$AZURE_AD_TENANT_ID" ]; then
          errors="$errors AZURE_AD_TENANT_ID"
        fi
        
        if [ -n "$errors" ]; then
          echo "âš ï¸ Required Azure AD secrets are not configured:$errors"
          echo ""
          echo "â„¹ï¸ To fix this:"
          echo "  1. Go to repository Settings > Secrets and variables > Actions"
          echo "  2. Add the following secrets:"
          echo "     - AZURE_AD_CLIENT_ID: Your Azure AD Application Client ID"
          echo "     - AZURE_AD_CLIENT_SECRET: Your Azure AD Application Client Secret"
          echo "     - AZURE_AD_TENANT_ID: Your Azure AD Tenant ID"
          echo "  3. See WORKFLOW_SECRET_SETUP.md for detailed instructions"
          echo ""
          echo "âš ï¸ Skipping Portal build due to missing secrets - API and SPFx will still be built"
          echo "has-secrets=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… All Azure AD secrets validated"
          echo "has-secrets=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Production Configuration for Portal
      if: steps.validate-secrets.outputs.has-secrets == 'true'
      env:
        AZURE_AD_CLIENT_ID: ${{ secrets.AZURE_AD_CLIENT_ID }}
        AZURE_AD_CLIENT_SECRET: ${{ secrets.AZURE_AD_CLIENT_SECRET }}
        AZURE_AD_TENANT_ID: ${{ secrets.AZURE_AD_TENANT_ID }}
      run: |
        # Create appsettings.Production.json with secrets from repository
        cat > src/portal-blazor/SharePointExternalUserManager.Portal/appsettings.Production.json << EOF
        {
          "AzureAd": {
            "ClientId": "$AZURE_AD_CLIENT_ID",
            "ClientSecret": "$AZURE_AD_CLIENT_SECRET",
            "TenantId": "$AZURE_AD_TENANT_ID"
          }
        }
        EOF
        echo "âœ… Production configuration created with secrets from repository"
    
    - name: Build Blazor Portal
      if: steps.validate-secrets.outputs.has-secrets == 'true'
      run: |
        cd src/portal-blazor/SharePointExternalUserManager.Portal
        dotnet restore
        dotnet build --configuration Release --no-restore
        dotnet publish --configuration Release --output ../../../../portal-publish --no-build
        
    # Build SPFx
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/client-spfx/package-lock.json'
        
    - name: Build SPFx Client
      run: |
        cd src/client-spfx
        npm ci --no-optional --legacy-peer-deps
        npm run build
        npm run package-solution
        
    # Upload artifacts
    - name: Upload API artifact
      uses: actions/upload-artifact@v4
      with:
        name: api-package
        path: api-publish
        retention-days: 1
        
    - name: Upload Portal artifact
      if: steps.validate-secrets.outputs.has-secrets == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: portal-package
        path: portal-publish
        retention-days: 1
        
    - name: Upload SPFx artifact
      uses: actions/upload-artifact@v4
      with:
        name: spfx-package
        path: src/client-spfx/sharepoint/solution/*.sppkg
        retention-days: 1
        
  # Job 2: Deploy Infrastructure (optional, manual trigger only)
  deploy-infrastructure:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    # Only run if workflow was manually triggered with deploy_infrastructure=true
    if: github.event.inputs.deploy_infrastructure == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Azure credentials
      env:
        AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      run: |
        if [ -z "$AZURE_CREDENTIALS" ]; then
          echo "âŒ AZURE_CREDENTIALS secret is not configured"
          echo "â„¹ï¸ To enable infrastructure deployment:"
          echo "  1. Go to repository Settings > Secrets and variables > Actions"
          echo "  2. Add AZURE_CREDENTIALS secret with Azure service principal credentials"
          exit 1
        fi
        echo "âœ… Azure credentials validated"
      
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy Bicep template
      run: |
        az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infra/bicep/main.bicep \
          --parameters environment=${{ env.ENVIRONMENT }} \
          --parameters sqlAdminUsername=${{ secrets.SQL_ADMIN_USERNAME }} \
          --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
          
    - name: Get deployment outputs
      id: deployment
      run: |
        outputs=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name main \
          --query properties.outputs)
        echo "Deployment outputs:"
        echo "$outputs"
        
    - name: Logout from Azure
      run: az logout
      
  # Job 3: Deploy API
  deploy-api:
    name: Deploy API to Production
    runs-on: ubuntu-latest
    needs: build
    environment: production  # Requires approval for production
    
    steps:
    - name: Download API artifact
      uses: actions/download-artifact@v4
      with:
        name: api-package
        path: ./api-package
        
    - name: Check deployment prerequisites
      id: check-prereqs
      env:
        API_PUBLISH_PROFILE_PROD: ${{ secrets.API_PUBLISH_PROFILE_PROD }}
      run: |
        if [ -z "$API_PUBLISH_PROFILE_PROD" ]; then
          echo "âš ï¸ API deployment skipped - API_PUBLISH_PROFILE_PROD secret not configured"
          echo ""
          echo "â„¹ï¸ To enable API deployment to production:"
          echo "  1. Go to Azure Portal â†’ Your Production API App Service"
          echo "  2. Click 'Get publish profile' in Overview"
          echo "  3. Copy the entire XML content"
          echo "  4. Go to repository Settings > Secrets and variables > Actions"
          echo "  5. Add secret named 'API_PUBLISH_PROFILE_PROD' with the XML content"
          echo "can-deploy=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… Deployment prerequisites validated"
          echo "can-deploy=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Deploy to Azure App Service
      if: steps.check-prereqs.outputs.can-deploy == 'true'
      uses: azure/webapps-deploy@v3
      with:
        app-name: 'spexternal-api-prod'  # Can be overridden by publish profile
        package: ./api-package
        publish-profile: ${{ secrets.API_PUBLISH_PROFILE_PROD }}
      
  # Job 4: Deploy Blazor Portal
  deploy-portal:
    name: Deploy Blazor Portal to Production
    runs-on: ubuntu-latest
    needs: build
    # Only run if portal was built (Azure AD secrets were present)
    if: needs.build.outputs.portal-built == 'true'
    environment: production  # Requires approval for production
    
    steps:
    - name: Download Portal artifact
      uses: actions/download-artifact@v4
      with:
        name: portal-package
        path: ./portal-package
        
    - name: Check deployment prerequisites
      id: check-prereqs
      env:
        PORTAL_PUBLISH_PROFILE_PROD: ${{ secrets.PORTAL_PUBLISH_PROFILE_PROD }}
      run: |
        if [ -z "$PORTAL_PUBLISH_PROFILE_PROD" ]; then
          echo "âš ï¸ Portal deployment skipped - PORTAL_PUBLISH_PROFILE_PROD secret not configured"
          echo ""
          echo "â„¹ï¸ To enable Portal deployment to production:"
          echo "  1. Go to Azure Portal â†’ Your Production Portal App Service"
          echo "  2. Click 'Get publish profile' in Overview"
          echo "  3. Copy the entire XML content"
          echo "  4. Go to repository Settings > Secrets and variables > Actions"
          echo "  5. Add secret named 'PORTAL_PUBLISH_PROFILE_PROD' with the XML content"
          echo "can-deploy=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… Deployment prerequisites validated"
          echo "can-deploy=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Deploy to Azure App Service
      if: steps.check-prereqs.outputs.can-deploy == 'true'
      uses: azure/webapps-deploy@v3
      with:
        app-name: 'spexternal-portal-prod'  # Can be overridden by publish profile
        package: ./portal-package
        publish-profile: ${{ secrets.PORTAL_PUBLISH_PROFILE_PROD }}
      
  # Job 5: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-portal]
    # Run if either deploy job completed (success, failure, or skipped)
    if: always()
    
    steps:
    - name: Generate Deployment Summary
      run: |
        API_STATUS="${{ needs.deploy-api.result }}"
        PORTAL_STATUS="${{ needs.deploy-portal.result }}"
        
        echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # API Status
        if [ "$API_STATUS" = "success" ]; then
          echo "- âœ… API App Service: Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "$API_STATUS" = "failure" ]; then
          echo "- âŒ API App Service: Deployment Failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ API App Service: Skipped (API_PUBLISH_PROFILE_PROD not configured)" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Portal Status
        if [ "$PORTAL_STATUS" = "success" ]; then
          echo "- âœ… Blazor Portal: Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        elif [ "$PORTAL_STATUS" = "failure" ]; then
          echo "- âŒ Blazor Portal: Deployment Failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Blazor Portal: Skipped (PORTAL_PUBLISH_PROFILE_PROD not configured)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- âœ… SPFx Package: Built Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Post-Deployment Checklist" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$API_STATUS" = "success" ] && [ "$PORTAL_STATUS" = "success" ]; then
          echo "- [ ] Verify API endpoints are responding correctly" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify Portal is accessible and functioning" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Run smoke tests on production environment" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Check application logs for errors" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify database migrations completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Deploy SPFx package to SharePoint App Catalog" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Notify stakeholders of successful deployment" >> $GITHUB_STEP_SUMMARY
        elif [ "$API_STATUS" = "skipped" ] || [ "$PORTAL_STATUS" = "skipped" ]; then
          echo "**Configuration Required:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$API_STATUS" = "skipped" ]; then
            echo "1. Configure \`API_PUBLISH_PROFILE_PROD\` secret to enable API deployment" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$PORTAL_STATUS" = "skipped" ]; then
            echo "2. Configure \`PORTAL_PUBLISH_PROFILE_PROD\` secret to enable Portal deployment" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [deployment documentation](../docs/DEPLOYMENT.md) for setup instructions." >> $GITHUB_STEP_SUMMARY
        else
          echo "**âš ï¸ Deployment Issues Detected**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the failed jobs above and take corrective action." >> $GITHUB_STEP_SUMMARY
        fi
