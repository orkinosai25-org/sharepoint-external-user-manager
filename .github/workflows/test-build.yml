# Test Build Workflow for SPFx Solution
# 
# This workflow only builds and packages the solution without deploying
# Useful for testing pull requests and validating builds
#
# Triggers on:
# - Pull requests to main branch
# - Manual dispatch

name: Test Build SPFx Solution

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.19.0'

jobs:
  test-build:
    name: Test Build SPFx Solution
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/client-spfx/package-lock.json'
        
    - name: Verify Node.js version
      run: |
        echo "Current Node.js version: $(node --version)"
        echo "Current npm version: $(npm --version)"
        echo "Expected Node.js version: ${{ env.NODE_VERSION }}"
        # Verify Node.js version matches expected
        if [[ "$(node --version)" != "v${{ env.NODE_VERSION }}" ]]; then
          echo "âŒ Node.js version mismatch!"
          echo "Expected: v${{ env.NODE_VERSION }}"
          echo "Actual: $(node --version)"
          exit 1
        fi
        echo "âœ… Node.js version verified"
        
    - name: Install dependencies
      working-directory: src/client-spfx
      run: |
        echo "Installing npm dependencies..."
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        npm ci --no-optional --legacy-peer-deps
        
    - name: Run linting (if available)
      working-directory: src/client-spfx
      run: |
        echo "Running ESLint..."
        if npm run lint --silent > /dev/null 2>&1; then
          npm run lint
        else
          echo "No lint script found, skipping..."
        fi
      continue-on-error: true
        
    - name: Build solution
      working-directory: src/client-spfx
      run: |
        echo "Building SPFx solution..."
        npm run build
        
    - name: Package solution
      working-directory: src/client-spfx
      run: |
        echo "Packaging SPFx solution..."
        npm run package-solution
        
    - name: Verify package creation
      working-directory: src/client-spfx
      run: |
        echo "Verifying package creation..."
        if ls sharepoint/solution/*.sppkg 1> /dev/null 2>&1; then
          echo "âœ… Package created successfully:"
          ls -la sharepoint/solution/*.sppkg
        else
          echo "âŒ Package not found in expected location"
          echo "Contents of sharepoint/solution/:"
          ls -la sharepoint/solution/ || echo "Solution directory not found"
          exit 1
        fi
        
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-spfx-package
        path: src/client-spfx/sharepoint/solution/*.sppkg
        retention-days: 7
        
    - name: Build Summary
      run: |
        echo "## ðŸŽ‰ Build Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "**Node.js Version**: $(node --version)" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The SPFx solution builds successfully and is ready for deployment." >> $GITHUB_STEP_SUMMARY