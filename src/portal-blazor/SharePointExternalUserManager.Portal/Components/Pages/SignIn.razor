@page "/account/signin"
@inject NavigationManager Navigation
@inject IConfiguration Configuration

<PageTitle>Sign In - ClientSpace</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center p-5">
                    <h2 class="mb-4">Sign In Required</h2>
                    
                    @if (isAzureAdConfigured)
                    {
                        <p class="text-muted mb-4">Redirecting to Microsoft authentication...</p>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning" role="alert">
                            <h5 class="alert-heading">
                                <span class="bi bi-exclamation-triangle-fill"></span>
                                Authentication Not Configured
                            </h5>
                            <p class="mb-0">
                                Microsoft Entra ID authentication is not configured for this application.
                                Please contact your system administrator to complete the setup.
                            </p>
                        </div>
                        
                        <div class="text-start mt-4">
                            <h6>Required Configuration:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <span class="bi @(hasClientId ? "bi-check-circle-fill text-success" : "bi-x-circle-fill text-danger")"></span>
                                    Azure AD Client ID
                                </li>
                                <li class="mb-2">
                                    <span class="bi @(hasClientSecret ? "bi-check-circle-fill text-success" : "bi-x-circle-fill text-danger")"></span>
                                    Azure AD Client Secret
                                </li>
                                <li class="mb-2">
                                    <span class="bi @(hasTenantId ? "bi-check-circle-fill text-success" : "bi-x-circle-fill text-danger")"></span>
                                    Azure AD Tenant ID
                                </li>
                            </ul>
                        </div>
                        
                        <a href="/" class="btn btn-outline-primary mt-3">
                            <span class="bi bi-arrow-left"></span> Return to Home
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isAzureAdConfigured = false;
    private bool hasClientId = false;
    private bool hasClientSecret = false;
    private bool hasTenantId = false;

    protected override void OnInitialized()
    {
        var azureAdConfig = Configuration.GetSection("AzureAd");
        var clientId = azureAdConfig["ClientId"];
        var clientSecret = azureAdConfig["ClientSecret"];
        var tenantId = azureAdConfig["TenantId"];

        hasClientId = IsValidConfigValue(clientId);
        hasClientSecret = IsValidConfigValue(clientSecret);
        hasTenantId = IsValidConfigValue(tenantId);

        isAzureAdConfigured = hasClientId && hasClientSecret && hasTenantId;

        if (isAzureAdConfigured)
        {
            // Redirect to Microsoft Identity sign-in
            Navigation.NavigateTo("MicrosoftIdentity/Account/SignIn", forceLoad: true);
        }
    }

    private static bool IsValidConfigValue(string? value)
    {
        return !string.IsNullOrWhiteSpace(value) && 
               !value.Contains("YOUR_", StringComparison.OrdinalIgnoreCase);
    }
}
